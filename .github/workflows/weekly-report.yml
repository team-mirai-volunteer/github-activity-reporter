name: Weekly GitHub Activity Report

on:
  schedule:
    # æ¯æ—¥åˆå‰9æ™‚ï¼ˆJSTï¼‰ã«å®Ÿè¡Œ
    - cron: '0 0 * * *'
  workflow_dispatch:
    inputs:
      repos:
        description: 'ãƒªãƒã‚¸ãƒˆãƒªåï¼ˆã‚«ãƒ³ãƒåŒºåˆ‡ã‚Šã€ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆ: action-board,fact-checkerï¼‰'
        required: false
        default: 'action-board,fact-checker'
      days:
        description: 'éå»ä½•æ—¥åˆ†ã‚’å–å¾—ã™ã‚‹ã‹'
        required: false
        default: '7'

jobs:
  generate-report:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout repository
      uses: actions/checkout@v4
    
    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.11'
    
    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install -r requirements.txt
    
    - name: Setup GitHub CLI
      run: |
        gh auth login --with-token <<< "${{ secrets.GITHUB_TOKEN }}"
    
    - name: Generate GitHub Activity Report
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        OPENAI_API_KEY: ${{ secrets.OPENAI_API_KEY }}
      run: |
        # ãƒªãƒã‚¸ãƒˆãƒªåã‚’è¨­å®šï¼ˆãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã¾ãŸã¯å…¥åŠ›å€¤ï¼‰
        REPOS="${{ github.event.inputs.repos || 'action-board,fact-checker' }}"
        DAYS="${{ github.event.inputs.days || '7' }}"
        
        # team-mirai-volunteerçµ„ç¹”ã‚’ä»˜ä¸
        FULL_REPOS=""
        for repo in $(echo $REPOS | tr ',' ' '); do
          if [ -z "$FULL_REPOS" ]; then
            FULL_REPOS="team-mirai-volunteer/$repo"
          else
            FULL_REPOS="$FULL_REPOS,team-mirai-volunteer/$repo"
          fi
        done
        
        echo "å‡¦ç†å¯¾è±¡ãƒªãƒã‚¸ãƒˆãƒª: $FULL_REPOS"
        
        # GitHubãƒ‡ãƒ¼ã‚¿ã‚’åé›†ã—ã¦Markdownãƒ¬ãƒãƒ¼ãƒˆã‚’ç”Ÿæˆ
        python -m src.github_logger.github_report \
          --repo "$FULL_REPOS" \
          --last-days "$DAYS" \
          --markdown \
          --output-dir "./data"
    
    - name: Generate AI Reports (if OpenAI API key is available)
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        OPENAI_API_KEY: ${{ secrets.OPENAI_API_KEY }}
      run: |
        if [ -n "$OPENAI_API_KEY" ]; then
          echo "OpenAI APIã‚­ãƒ¼ãŒè¨­å®šã•ã‚Œã¦ã„ã‚‹ãŸã‚ã€AIãƒ¬ãƒãƒ¼ãƒˆã‚’ç”Ÿæˆã—ã¾ã™"
          
          # action-boardç”¨AIãƒ¬ãƒãƒ¼ãƒˆç”Ÿæˆ
          if echo "${{ github.event.inputs.repos || 'action-board,fact-checker' }}" | grep -q "action-board"; then
            python -m src.call_openai_api github \
              --repo "team-mirai-volunteer/action-board" \
              --prompt-file "./prompts/action_board_prompt.txt" \
              --data-dir "./data" || echo "action-board AIãƒ¬ãƒãƒ¼ãƒˆç”Ÿæˆã«å¤±æ•—ã—ã¾ã—ãŸ"
          fi
          
          # fact-checkerç”¨AIãƒ¬ãƒãƒ¼ãƒˆç”Ÿæˆ
          if echo "${{ github.event.inputs.repos || 'action-board,fact-checker' }}" | grep -q "fact-checker"; then
            python -m src.call_openai_api github \
              --repo "team-mirai-volunteer/fact-checker" \
              --prompt-file "./prompts/fact_checker_prompt.txt" \
              --data-dir "./data" || echo "fact-checker AIãƒ¬ãƒãƒ¼ãƒˆç”Ÿæˆã«å¤±æ•—ã—ã¾ã—ãŸ"
          fi
        else
          echo "OpenAI APIã‚­ãƒ¼ãŒè¨­å®šã•ã‚Œã¦ã„ãªã„ãŸã‚ã€AIãƒ¬ãƒãƒ¼ãƒˆã®ç”Ÿæˆã‚’ã‚¹ã‚­ãƒƒãƒ—ã—ã¾ã™"
        fi
    
    - name: Upload reports as artifacts
      uses: actions/upload-artifact@v4
      with:
        name: github-activity-reports
        path: |
          data/*/markdown/github/*.md
          data/*/ai_reports/*.md
          data/*/raw/commits/*.json
        retention-days: 30
    
    - name: Collect Commit Statistics
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        GOOGLE_SHEETS_CREDENTIALS_FILE: ${{ secrets.GOOGLE_SHEETS_CREDENTIALS_FILE }}
        GOOGLE_SHEETS_SPREADSHEET_ID: ${{ secrets.GOOGLE_SHEETS_SPREADSHEET_ID }}
      run: |
        if [ -n "$GOOGLE_SHEETS_CREDENTIALS_FILE" ] && [ -n "$GOOGLE_SHEETS_SPREADSHEET_ID" ]; then
          echo "Google Sheetsèªè¨¼æƒ…å ±ãŒè¨­å®šã•ã‚Œã¦ã„ã‚‹ãŸã‚ã€ã‚³ãƒŸãƒƒãƒˆçµ±è¨ˆã‚’åé›†ã—ã¾ã™"
          
          # Google Sheetsèªè¨¼ãƒ•ã‚¡ã‚¤ãƒ«ã‚’ä½œæˆï¼ˆbase64ãƒ‡ã‚³ãƒ¼ãƒ‰ï¼‰
          echo "$GOOGLE_SHEETS_CREDENTIALS_FILE" | base64 -d > /tmp/google-credentials.json
          export GOOGLE_SHEETS_CREDENTIALS_FILE="/tmp/google-credentials.json"
          
          # ã‚³ãƒŸãƒƒãƒˆçµ±è¨ˆã‚’åé›†ã—ã¦Google Sheetsã«æ›¸ãè¾¼ã¿
          python -m src.commit_collector \
            --days 30 \
            --output-dir "./data" \
            --clear-sheet || echo "ã‚³ãƒŸãƒƒãƒˆçµ±è¨ˆã®åé›†ã«å¤±æ•—ã—ã¾ã—ãŸ"
        else
          echo "Google Sheetsèªè¨¼æƒ…å ±ãŒè¨­å®šã•ã‚Œã¦ã„ãªã„ãŸã‚ã€ã‚³ãƒŸãƒƒãƒˆçµ±è¨ˆã®åé›†ã‚’ã‚¹ã‚­ãƒƒãƒ—ã—ã¾ã™"
        fi

    - name: Create summary
      run: |
        echo "## ğŸ“Š GitHub Activity Report Generated" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "### ç”Ÿæˆã•ã‚ŒãŸãƒ•ã‚¡ã‚¤ãƒ«:" >> $GITHUB_STEP_SUMMARY
        
        # Markdownãƒ¬ãƒãƒ¼ãƒˆãƒ•ã‚¡ã‚¤ãƒ«ã‚’ä¸€è¦§è¡¨ç¤º
        if ls data/*/markdown/github/*.md 1> /dev/null 2>&1; then
          echo "#### Markdownãƒ¬ãƒãƒ¼ãƒˆ:" >> $GITHUB_STEP_SUMMARY
          for file in data/*/markdown/github/*.md; do
            echo "- \`$(basename "$file")\`" >> $GITHUB_STEP_SUMMARY
          done
          echo "" >> $GITHUB_STEP_SUMMARY
        fi
        
        # AIãƒ¬ãƒãƒ¼ãƒˆãƒ•ã‚¡ã‚¤ãƒ«ã‚’ä¸€è¦§è¡¨ç¤º
        if ls data/*/ai_reports/*.md 1> /dev/null 2>&1; then
          echo "#### AIãƒ¬ãƒãƒ¼ãƒˆ:" >> $GITHUB_STEP_SUMMARY
          for file in data/*/ai_reports/*.md; do
            echo "- \`$(basename "$file")\`" >> $GITHUB_STEP_SUMMARY
          done
          echo "" >> $GITHUB_STEP_SUMMARY
        fi
        
        # ã‚³ãƒŸãƒƒãƒˆçµ±è¨ˆãƒ•ã‚¡ã‚¤ãƒ«ã‚’ä¸€è¦§è¡¨ç¤º
        if ls data/*/raw/commits/*.json 1> /dev/null 2>&1; then
          echo "#### ã‚³ãƒŸãƒƒãƒˆçµ±è¨ˆ:" >> $GITHUB_STEP_SUMMARY
          for file in data/*/raw/commits/*.json; do
            echo "- \`$(basename "$file")\`" >> $GITHUB_STEP_SUMMARY
          done
          echo "" >> $GITHUB_STEP_SUMMARY
        fi
        
        echo "ãƒ¬ãƒãƒ¼ãƒˆã¯Artifactsã‹ã‚‰ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰ã§ãã¾ã™ã€‚" >> $GITHUB_STEP_SUMMARY
